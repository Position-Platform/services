version: "3"
services:
    position-api:
        build:
            context: .
            dockerfile: .docker/Dockerfile
        image: position-api
        container_name: position-api
        ports:
            - "${APP_PORT:-80}:80"
        volumes:
            - ./:/var/www/html
            - ./docker/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
        networks:
            - position-api
        depends_on:
            - position-api-pgsql

    position-api-pgsql:
        restart: always
        build:
            context: .
            dockerfile: .docker/Dockerfile-db
        ports:
            - "${FORWARD_DB_PORT:-5432}:5432"
        container_name: position-api-pgsql
        environment:
            PGPASSWORD: "${PG_PASSWORD:-secret}"
            POSTGRES_DB: "${DB_DATABASE}"
            POSTGRES_USER: "${DB_USERNAME}"
            POSTGRES_PASSWORD: "${DB_PASSWORD:-secret}"
        networks:
            - position-api
        healthcheck:
            test:
                [
                    "CMD",
                    "pg_isready",
                    "-q",
                    "-d",
                    "${DB_DATABASE}",
                    "-U",
                    "${DB_USERNAME}",
                ]
            retries: 3
            timeout: 5s

    position-api-meilisearch:
        container_name: position-api-meilisearch
        image: getmeili/meilisearch:v1.3
        environment:
            - http_proxy
            - https_proxy
            - MEILI_NO_ANALYTICS=${MEILI_NO_ANALYTICS:-true}
            - MEILI_ENV=${MEILI_ENV:-development}
            - MEILI_LOG_LEVEL
            - MEILI_DB_PATH=${MEILI_DB_PATH:-/data.ms}
        ports:
            - ${MEILI_PORT:-7700}:7700
        networks:
            - position-api
        volumes:
            - "position-meilisearch:/data.ms"
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--spider",
                    "http://position-api-meilisearch:7700/health",
                ]
            retries: 3
            timeout: 5s
networks:
    position-api:
        driver: bridge
volumes:
    position-meilisearch:
        driver: local